<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión Inmobiliaria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
        <!-- Librería jsPDF para generación de PDFs -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Estilos para una scrollbar más delgada y estilizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .transition-all { transition: all 0.3s ease-in-out; }
        /* Ocultar flechas en input de tipo number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
          -webkit-appearance: none; 
          margin: 0; 
        }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="flex h-screen">
        <!-- Barra de Navegación Lateral (Sidebar) -->
        <aside class="bg-gray-800 text-white w-64 space-y-6 py-7 px-2 fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-200 ease-in-out z-30">
            <a href="#" class="text-white flex items-center space-x-2 px-4">
                <i class="fas fa-building text-2xl"></i>
                <span class="text-2xl font-extrabold">InmoGest</span>
            </a>
            <nav>
                <a href="#dashboard" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700 bg-gray-700">
                    <i class="fas fa-tachometer-alt w-6 mr-2"></i>Dashboard
                </a>
                <a href="#propiedades" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-home w-6 mr-2"></i>Propiedades
                </a>
                <a href="#personas" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-users w-6 mr-2"></i>Personas
                </a>
                <a href="#contratos" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-file-signature w-6 mr-2"></i>Contratos
                </a>
                <!-- Enlace agregado para el módulo de incidencias -->
                <a href="#incidencias" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-tools w-6 mr-2"></i>Incidencias
                </a>
                <!-- Enlace agregado para el módulo de liquidaciones -->
                <a href="#liquidaciones" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-file-invoice-dollar w-6 mr-2"></i>Liquidaciones
                </a>
                <!-- Enlace agregado para el módulo de servicios -->
                <a href="#servicios" onclick="navigateToSection('servicios-section')" class="nav-link block py-2.5 px-4 rounded transition duration-200 hover:bg-gray-700">
                    <i class="fas fa-lightbulb w-6 mr-2"></i>Servicios
                </a>
            </nav>
        </aside>

        <!-- Contenido Principal -->
        <main class="flex-1 p-6 md:p-10 overflow-y-auto">
            <div id="main-content-area">
                <!-- El contenido de la sección activa se renderizará aquí -->
            </div>
        </main>
    </div>

    <!-- Modales -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-40">
        <div id="modal-content" class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md mx-auto"></div>
    </div>
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm mx-auto">
            <h2 class="text-xl font-bold mb-4">Confirmar Eliminación</h2>
            <p class="mb-6">¿Estás seguro? Esta acción no se puede deshacer.</p>
            <div class="flex items-center justify-end">
                <button id="cancel-delete-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded mr-2">Cancelar</button>
                <button id="confirm-delete-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalle Contrato: muestra la información del contrato y permite registrar pagos -->
    <div id="modal-detalle-contrato" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-4">Detalle de Contrato</h2>
            <div id="detalle-contrato-info" class="mb-4 text-sm space-y-1"></div>
            <!-- Sección de Aumentos: información del contrato relacionada con aumentos y botón para aplicarlo -->
            <h3 class="text-xl font-bold my-2">Aumentos</h3>
            <div id="aumentos-info" class="mb-4 text-sm"></div>
            <button id="aplicar-aumento-btn" class="bg-purple-500 hover:bg-purple-600 text-white py-2 px-4 rounded mb-4 hidden">Aplicar Aumento</button>
            <h3 class="text-xl font-bold my-2">Pagos</h3>
            <table class="min-w-full mb-4 text-sm">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="py-2 px-4 text-left">Mes</th>
                        <th class="py-2 px-4 text-left">Año</th>
                        <th class="py-2 px-4 text-left">Monto</th>
                        <th class="py-2 px-4 text-left">Estado</th>
                        <th class="py-2 px-4 text-left">Recibo</th>
                    </tr>
                </thead>
                <tbody id="pagos-list"></tbody>
            </table>
            <!-- Formulario para nuevo pago (se muestra al hacer clic en Agregar Pago) -->
            <div id="nuevo-pago-form-container" class="mb-4 hidden">
                <h4 class="text-lg font-bold mb-2">Nuevo Pago</h4>
                <form id="nuevo-pago-form" class="space-y-2">
                    <input type="number" id="pago-mes" class="shadow border rounded w-full py-2 px-3 text-gray-700" placeholder="Mes (1-12)" min="1" max="12" required>
                    <input type="number" id="pago-anio" class="shadow border rounded w-full py-2 px-3 text-gray-700" placeholder="Año (e.g. 2025)" required>
                    <input type="number" id="pago-monto" step="0.01" class="shadow border rounded w-full py-2 px-3 text-gray-700" placeholder="Monto" required>
                    <select id="pago-estado" class="shadow border rounded w-full py-2 px-3 text-gray-700" required>
                        <option value="Pagado">Pagado</option>
                        <option value="Pendiente">Pendiente</option>
                    </select>
                    <div class="flex justify-end gap-2">
                        <button type="button" id="cancelar-pago-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-1 px-3 rounded">Cancelar</button>
                        <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-1 px-3 rounded">Guardar Pago</button>
                    </div>
                </form>
            </div>
            <div class="flex justify-end gap-2">
                <button id="agregar-pago-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded">Agregar Pago</button>
                <button id="cerrar-detalle-contrato-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded">Cerrar</button>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, getDoc, setDoc, deleteDoc, onSnapshot, Timestamp, query, where, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQFTvKLmUnLXa5GCAx8PQORmFolnssX04",
            authDomain: "mi-app-inmobiliaria-3d461.firebaseapp.com",
            projectId: "mi-app-inmobiliaria-3d461",
            storageBucket: "mi-app-inmobiliaria-3d461.appspot.com",
            messagingSenderId: "401339260242",
            appId: "1:401339260242:web:49502eee63772e7433ee8b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let state = {
            currentSection: 'dashboard',
            currentItemId: null,
            // Agregamos "incidencias" al estado para gestionar el nuevo módulo
            data: { propiedades: [], personas: [], contratos: [], incidencias: [] },
            isAuthReady: false
        };

        // Identificador del contrato actualmente abierto en el modal de detalle
        let currentContratoId = null;

        const mainContentArea = document.getElementById('main-content-area');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modal-content');
        const confirmModal = document.getElementById('confirm-modal');

        function navigateTo(sectionId, itemId = null) {
            state.currentSection = sectionId;
            state.currentItemId = itemId;
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-gray-700');
                if (link.getAttribute('href') === `#${sectionId}`) {
                    link.classList.add('bg-gray-700');
                }
            });
            renderCurrentSection();
            // Al navegar a cualquier sección dinámica, ocultamos la sección de servicios y mostramos el área principal
            const serviciosSectionEl = document.getElementById('servicios-section');
            if (serviciosSectionEl) {
                serviciosSectionEl.classList.add('hidden');
                mainContentArea.classList.remove('hidden');
            }
        }

        // Navegación para secciones estáticas (Servicios)
        // Exponemos navigateToSection en el objeto window para que pueda usarse desde los atributos onclick
        window.navigateToSection = function(sectionId) {
            // ocultar el contenido dinámico y otras secciones
            const mainContentArea = document.getElementById('main-content-area');
            if (mainContentArea) mainContentArea.classList.add('hidden');
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            const target = document.getElementById(sectionId);
            if (target) {
                target.classList.remove('hidden');
            }
            // actualizar el estado activo en el menú lateral
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('bg-gray-700');
            });
            const linkMatch = document.querySelector("a[onclick*=\"navigateToSection('" + sectionId + "')\"]");
            if (linkMatch) {
                linkMatch.classList.add('bg-gray-700');
            }
        }

        function renderCurrentSection() {
            if (!state.isAuthReady) {
                 mainContentArea.innerHTML = `<div class="text-center py-10"><i class="fas fa-spinner fa-spin text-4xl text-gray-500"></i><p class="mt-4">Conectando...</p></div>`;
                 return;
            }
            
            // Si estamos en la sección de incidencias, utilizamos una vista personalizada
            if (state.currentSection === 'incidencias') {
                renderIncidencias();
                return;
            }
            // Si estamos en la sección de liquidaciones, utilizamos una vista personalizada
            if (state.currentSection === 'liquidaciones') {
                renderLiquidaciones();
                return;
            }

            if (state.currentItemId) {
                renderDetailView();
            } else {
                renderTableView();
            }
        }
        
        function renderTableView() {
            if (state.currentSection === 'dashboard') {
                renderDashboard();
                return;
            }

            const sectionConfig = {
                propiedades: { title: 'Propiedades', headers: ['Dirección', 'Tipo', 'Descripción', 'Precio Alquiler', 'Acciones'], renderRow: renderPropiedadRow },
                personas: { title: 'Personas', headers: ['Nombre Completo', 'DNI', 'Email', 'Teléfono', 'Rol', 'Acciones'], renderRow: renderPersonaRow },
                contratos: { title: 'Contratos', headers: ['Propiedad', 'Inquilino', 'Fecha Inicio', 'Fecha Fin', 'Monto Mensual', 'Estado', 'Acciones'], renderRow: renderContratoRow }
            };

            const config = sectionConfig[state.currentSection];
            if (!config) return;

            const data = state.data[state.currentSection];
            const tableHeaders = config.headers.map(h => `<th class="py-3 px-6 text-left">${h}</th>`).join('');
            const tableRows = data.length > 0 ? data.map(item => config.renderRow(item)).join('') : `<tr><td colspan="${config.headers.length}" class="text-center py-4">No hay registros.</td></tr>`;

            mainContentArea.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Gestión de ${config.title}</h1>
                    <button onclick="window.openModal('${state.currentSection}')" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all">
                        <i class="fas fa-plus mr-2"></i>Nuevo ${config.title.slice(0, -1)}
                    </button>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal"><tr>${tableHeaders}</tr></thead>
                        <tbody class="text-gray-600 text-sm font-light">${tableRows}</tbody>
                    </table>
                </div>`;
        }
        
        function renderDashboard() {
            const hoy = new Date();
            const limite30dias = new Date();
            limite30dias.setDate(hoy.getDate() + 30);

            const contratosPorActualizar = state.data.contratos.filter(c => {
                if (!c.fecha_actualizacion) return false;
                const fechaActualizacion = new Date(c.fecha_actualizacion);
                return fechaActualizacion >= hoy && fechaActualizacion <= limite30dias;
            });

            let alertasHtml = `<div class="p-4"><p class="text-gray-500">No hay actualizaciones próximas.</p></div>`;
            if (contratosPorActualizar.length > 0) {
                alertasHtml = contratosPorActualizar.map(c => {
                    const propiedad = state.data.propiedades.find(p => p.id === c.propiedad_id) || { direccion: 'N/A' };
                    const inquilino = state.data.personas.find(p => p.id === c.inquilino_id) || { nombre: 'N/A', apellido: '' };
                    const fecha = new Date(c.fecha_actualizacion).toLocaleDateString('es-ES', {timeZone: 'UTC'});
                    return `<div class="flex justify-between items-center p-4 border-b">
                                <div>
                                    <p class="font-semibold">${propiedad.direccion}</p>
                                    <p class="text-sm text-gray-600">Inquilino: ${inquilino.nombre} ${inquilino.apellido}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-blue-600">${fecha}</p>
                                    <p class="text-sm text-gray-500">Fecha de Actualización</p>
                                </div>
                            </div>`;
                }).join('');
            }
            
            mainContentArea.innerHTML = `
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Dashboard</h1>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold text-gray-700 mb-4">Próximas Actualizaciones de Contratos</h2>
                        <div class="divide-y">${alertasHtml}</div>
                    </div>
                </div>`;
        }

        function renderDetailView() {
            if (state.currentSection !== 'contratos' || !state.currentItemId) {
                navigateTo(state.currentSection);
                return;
            }

            const contrato = state.data.contratos.find(c => c.id === state.currentItemId);
            if (!contrato) {
                mainContentArea.innerHTML = `<p>Contrato no encontrado.</p>`;
                return;
            }
            
            const propiedad = state.data.propiedades.find(p => p.id === contrato.propiedad_id) || {};
            const inquilino = state.data.personas.find(p => p.id === contrato.inquilino_id) || {};

            let mesesHtml = '';
            const fechaInicio = new Date(contrato.fecha_inicio + 'T00:00:00');
            const fechaFin = new Date(contrato.fecha_fin + 'T00:00:00');
            let fechaActual = new Date(fechaInicio.getFullYear(), fechaInicio.getMonth(), 1);

            while(fechaActual <= fechaFin) {
                const mesKey = `${fechaActual.getFullYear()}-${(fechaActual.getMonth() + 1).toString().padStart(2, '0')}`;
                const mesNombre = fechaActual.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
                const estadoActual = (contrato.pagos && contrato.pagos[mesKey]) ? contrato.pagos[mesKey] : 'Pendiente';
                
                const statusColors = {
                    'Pagado': 'bg-green-100 text-green-800',
                    'Pago Parcial': 'bg-yellow-100 text-yellow-800',
                    'Pendiente': 'bg-red-100 text-red-800'
                };

                mesesHtml += `
                    <div class="flex justify-between items-center p-3 border-b">
                        <span class="capitalize">${mesNombre}</span>
                        <select onchange="window.updatePaymentStatus('${contrato.id}', '${mesKey}', this.value)" class="rounded-lg px-2 py-1 text-sm font-semibold ${statusColors[estadoActual]}">
                            <option value="Pendiente" ${estadoActual === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                            <option value="Pago Parcial" ${estadoActual === 'Pago Parcial' ? 'selected' : ''}>Pago Parcial</option>
                            <option value="Pagado" ${estadoActual === 'Pagado' ? 'selected' : ''}>Pagado</option>
                        </select>
                    </div>
                `;
                fechaActual.setMonth(fechaActual.getMonth() + 1);
            }

            mainContentArea.innerHTML = `
                <div class="mb-6">
                    <button onclick="navigateTo('contratos')" class="text-blue-600 hover:underline"><i class="fas fa-arrow-left mr-2"></i>Volver a Contratos</button>
                </div>
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <h1 class="text-2xl font-bold text-gray-800 mb-4">Detalle del Contrato</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div><p class="text-sm text-gray-500">Propiedad</p><p class="font-semibold">${propiedad.direccion || 'N/A'}</p></div>
                        <div><p class="text-sm text-gray-500">Inquilino</p><p class="font-semibold">${inquilino.nombre || ''} ${inquilino.apellido || ''}</p></div>
                        <div><p class="text-sm text-gray-500">Fecha de Inicio</p><p class="font-semibold">${new Date(contrato.fecha_inicio).toLocaleDateString('es-ES',{timeZone:'UTC'})}</p></div>
                        <div><p class="text-sm text-gray-500">Fecha de Fin</p><p class="font-semibold">${new Date(contrato.fecha_fin).toLocaleDateString('es-ES',{timeZone:'UTC'})}</p></div>
                        <div><p class="text-sm text-gray-500">Monto Mensual</p><p class="font-semibold">$${parseFloat(contrato.monto).toFixed(2)}</p></div>
                    </div>
                    
                    <h2 class="text-xl font-bold text-gray-700 mt-10 mb-4">Estado de Pagos</h2>
                    <div class="border rounded-lg">${mesesHtml}</div>
                </div>
            `;
        }

        window.updatePaymentStatus = async (contractId, monthKey, newStatus) => {
            const docRef = doc(db, "contratos", contractId);
            try {
                await setDoc(docRef, { 
                    pagos: { [monthKey]: newStatus }
                }, { merge: true });
            } catch (error) {
                console.error("Error al actualizar el estado de pago:", error);
            }
        };

        function renderPropiedadRow(p) {
            return `<tr class="border-b border-gray-200 hover:bg-gray-100">
                <td class="py-3 px-6">${p.direccion}</td>
                <td class="py-3 px-6">${p.tipo}</td>
                <td class="py-3 px-6">${p.descripcion}</td>
                <td class="py-3 px-6 text-right">$${parseFloat(p.precio_alquiler).toFixed(2)}</td>
                ${renderActionsCell('propiedades', p.id)}
            </tr>`;
        }
        function renderPersonaRow(p) {
            return `<tr class="border-b border-gray-200 hover:bg-gray-100">
                <td class="py-3 px-6">${p.nombre} ${p.apellido}</td>
                <td class="py-3 px-6">${p.dni}</td>
                <td class="py-3 px-6">${p.email}</td>
                <td class="py-3 px-6">${p.telefono}</td>
                <td class="py-3 px-6"><span class="bg-purple-200 text-purple-600 py-1 px-3 rounded-full text-xs">${p.rol}</span></td>
                ${renderActionsCell('personas', p.id)}
            </tr>`;
        }
        function renderContratoRow(c) {
            const prop = state.data.propiedades.find(p => p.id === c.propiedad_id) || {};
            const inq = state.data.personas.find(p => p.id === c.inquilino_id) || {};
            const estadoClass = c.estado === 'Activo' ? 'bg-green-200 text-green-600' : 'bg-red-200 text-red-600';
            return `<tr class="border-b border-gray-200 hover:bg-gray-100">
                <td class="py-3 px-6">${prop.direccion || 'N/A'}</td>
                <td class="py-3 px-6">${inq.nombre || ''} ${inq.apellido || ''}</td>
                <td class="py-3 px-6">${new Date(c.fecha_inicio).toLocaleDateString('es-ES',{timeZone:'UTC'})}</td>
                <td class="py-3 px-6">${new Date(c.fecha_fin).toLocaleDateString('es-ES',{timeZone:'UTC'})}</td>
                <td class="py-3 px-6 text-right">$${parseFloat(c.monto).toFixed(2)}</td>
                <td class="py-3 px-6 text-center"><span class="${estadoClass} py-1 px-3 rounded-full text-xs">${c.estado}</span></td>
                ${renderActionsCell('contratos', c.id)}
            </tr>`;
        }
        function renderActionsCell(type, id) {
            // Para contratos utilizamos una vista detallada personalizada mediante openDetalleContrato
            const viewAction = type === 'contratos' ? `<div onclick="window.openDetalleContrato('${id}')" class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110 cursor-pointer"><i class="fas fa-eye"></i></div>` : `<div class="w-4 mr-2 text-gray-300 cursor-not-allowed"><i class="fas fa-eye"></i></div>`;
            return `<td class="py-3 px-6 text-center">
                <div class="flex item-center justify-center">
                    ${viewAction}
                    <div onclick="window.openModal('${type}', '${id}')" class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110 cursor-pointer"><i class="fas fa-pencil-alt"></i></div>
                    <div onclick="window.confirmDelete('${type}', '${id}')" class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110 cursor-pointer"><i class="fas fa-trash-alt"></i></div>
                </div>
            </td>`;
        }

        window.openModal = async (type, id = null) => {
            let data = {};
            if (id) {
                const docSnap = await getDoc(doc(db, type, id));
                if (docSnap.exists()) data = docSnap.data();
            }
            const formConfig = {
                propiedades: getPropiedadForm(data, id),
                personas: getPersonaForm(data, id),
                contratos: getContratoForm(data, id)
            };
            modalContent.innerHTML = formConfig[type];
            modal.classList.remove('hidden');
            modalContent.querySelector('form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleSave(type, id);
            });
        };
        window.closeModal = () => { modal.classList.add('hidden'); modalContent.innerHTML = ''; };

function getPropiedadForm(data, id) {
    // Generamos opciones para seleccionar al propietario. Solo listamos personas con rol Propietario
    const propietariosOpts = state.data.personas
        .filter(p => p.rol === 'Propietario')
        .map(p => `<option value="${p.id}" ${data.propietario_id === p.id ? 'selected' : ''}>${p.nombre} ${p.apellido || ''}</option>`)
        .join('');
    return `<h2 class="text-2xl font-bold mb-4">${id ? 'Editar' : 'Nueva'} Propiedad</h2><form><input type="hidden" id="docId" value="${id||''}"><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="direccion">Dirección</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="direccion" type="text" value="${data.direccion||''}" required></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="tipo">Tipo</label><select id="tipo" class="shadow border rounded w-full py-2 px-3 text-gray-700" required><option value="Departamento" ${data.tipo==='Departamento'?'selected':''}>Departamento</option><option value="Casa" ${data.tipo==='Casa'?'selected':''}>Casa</option><option value="Oficina" ${data.tipo==='Oficina'?'selected':''}>Oficina</option></select></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="descripcion">Descripción</label><textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="descripcion" rows="3">${data.descripcion||''}</textarea></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="precio_alquiler">Precio Alquiler ($)</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="precio_alquiler" type="number" step="0.01" value="${data.precio_alquiler||''}" required></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="propietario_id">Propietario</label><select id="propietario_id" class="shadow border rounded w-full py-2 px-3 text-gray-700"><option value="">Seleccione propietario...</option>${propietariosOpts}</select></div>${getFormButtons()}</form>`;
}
        function getPersonaForm(data, id) { return `<h2 class="text-2xl font-bold mb-4">${id ? 'Editar' : 'Nueva'} Persona</h2><form><input type="hidden" id="docId" value="${id||''}"><div class="grid grid-cols-2 gap-4"><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="nombre">Nombre</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="nombre" type="text" value="${data.nombre||''}" required></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="apellido">Apellido</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="apellido" type="text" value="${data.apellido||''}" required></div></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="dni">DNI</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="dni" type="text" value="${data.dni||''}" required></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="email">Email</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="email" type="email" value="${data.email||''}" required></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="telefono">Teléfono</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="telefono" type="tel" value="${data.telefono||''}"></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="rol">Rol</label><select id="rol" class="shadow border rounded w-full py-2 px-3 text-gray-700" required><option value="Inquilino" ${data.rol==='Inquilino'?'selected':''}>Inquilino</option><option value="Propietario" ${data.rol==='Propietario'?'selected':''}>Propietario</option><option value="Garante" ${data.rol==='Garante'?'selected':''}>Garante</option></select></div>${getFormButtons()}</form>`;}
        function getContratoForm(data, id) {
            const props = state.data.propiedades.map(p => `<option value="${p.id}" ${data.propiedad_id === p.id ? 'selected' : ''}>${p.direccion}</option>`).join('');
            const inqs = state.data.personas.filter(p => p.rol === 'Inquilino').map(p => `<option value="${p.id}" ${data.inquilino_id === p.id ? 'selected' : ''}>${p.nombre} ${p.apellido}</option>`).join('');
            return `<h2 class="text-2xl font-bold mb-4">${id ? 'Editar' : 'Nuevo'} Contrato</h2><form><input type="hidden" id="docId" value="${id || ''}"><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="contrato-propiedad">Propiedad</label><select id="contrato-propiedad" class="shadow border rounded w-full py-2 px-3 text-gray-700" required>${props}</select></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="contrato-inquilino">Inquilino</label><select id="contrato-inquilino" class="shadow border rounded w-full py-2 px-3 text-gray-700" required>${inqs}</select></div><div class="grid grid-cols-2 gap-4"><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="fecha-inicio">Fecha Inicio</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="fecha-inicio" type="date" value="${data.fecha_inicio||''}" required></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="fecha-fin">Fecha Fin</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="fecha-fin" type="date" value="${data.fecha_fin||''}" required></div></div><div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="contrato-monto">Monto Mensual ($)</label><input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" id="contrato-monto" type="number" step="0.01" value="${data.monto||''}" required></div>` +
                // Campos de aumento de alquiler
                `<div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="tipo-aumento">Tipo de Aumento</label><select id="tipo-aumento" class="shadow border rounded w-full py-2 px-3 text-gray-700"><option value="">Sin aumentos</option><option value="ICL" ${data.aumento?.tipo === 'ICL' ? 'selected' : ''}>ICL</option><option value="IPC" ${data.aumento?.tipo === 'IPC' ? 'selected' : ''}>IPC</option><option value="Cuatrimestral" ${data.aumento?.tipo === 'Cuatrimestral' ? 'selected' : ''}>Cuatrimestral</option><option value="Porcentaje fijo" ${data.aumento?.tipo === 'Porcentaje fijo' ? 'selected' : ''}>Porcentaje fijo</option></select></div>` +
                `<div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="frecuencia-aumento">Frecuencia (meses)</label><input id="frecuencia-aumento" type="number" min="1" step="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" value="${data.aumento?.frecuencia || ''}"></div>` +
                `<div class="mb-4"><label class="block text-gray-700 text-sm font-bold mb-2" for="fecha-inicio-aumento">Fecha Inicio Aumento</label><input id="fecha-inicio-aumento" type="date" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" value="${data.aumento?.fecha_inicio || ''}"></div>` +
                `${getFormButtons()}</form>`;
        }
        function getFormButtons() { return `<div class="flex items-center justify-end mt-6"><button type="button" onclick="window.closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">Cancelar</button><button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Guardar</button></div>`; }
        
        async function handleSave(type, id) {
            let data;
            if (type === 'contratos') {
                const fechaInicioValue = document.getElementById('fecha-inicio').value;
                const fechaInicio = new Date(fechaInicioValue + 'T00:00:00');
                const fechaActualizacion = new Date(new Date(fechaInicio).setFullYear(fechaInicio.getFullYear() + 1));
                data = {
                    propiedad_id: document.getElementById('contrato-propiedad').value,
                    inquilino_id: document.getElementById('contrato-inquilino').value,
                    fecha_inicio: fechaInicioValue,
                    fecha_fin: document.getElementById('fecha-fin').value,
                    monto: parseFloat(document.getElementById('contrato-monto').value),
                    estado: 'Activo',
                    fecha_actualizacion: fechaActualizacion.toISOString().split('T')[0],
                    pagos: {}
                };
                // Capturamos la configuración de aumento, si se definió
                const tipoAumento = document.getElementById('tipo-aumento')?.value;
                const frecuenciaAumento = document.getElementById('frecuencia-aumento')?.value;
                const fechaInicioAumento = document.getElementById('fecha-inicio-aumento')?.value;
                if (tipoAumento) {
                    data.aumento = {
                        tipo: tipoAumento,
                        frecuencia: frecuenciaAumento ? parseInt(frecuenciaAumento) : null,
                        fecha_inicio: fechaInicioAumento || null
                    };
                    // Inicializamos historial de aumentos si no existe
                    data.historialAumentos = [];
                }
                if(id) {
                    const docSnap = await getDoc(doc(db, "contratos", id));
                    if(docSnap.exists()) {
                        const existing = docSnap.data();
                        // preservamos pagos existentes
                        if(existing.pagos) data.pagos = existing.pagos;
                        // preservamos historial de aumentos existentes
                        if(existing.historialAumentos && !data.historialAumentos) data.historialAumentos = existing.historialAumentos;
                    }
                }
            } else if (type === 'propiedades') {
                // Guardamos también el propietario seleccionado. Si no hay ninguno, se almacena null
                data = {
                    direccion: document.getElementById('direccion').value,
                    tipo: document.getElementById('tipo').value,
                    descripcion: document.getElementById('descripcion').value,
                    precio_alquiler: parseFloat(document.getElementById('precio_alquiler').value),
                    propietario_id: document.getElementById('propietario_id').value || null
                };
            } else if (type === 'personas') {
                data = { nombre: document.getElementById('nombre').value, apellido: document.getElementById('apellido').value, dni: document.getElementById('dni').value, email: document.getElementById('email').value, telefono: document.getElementById('telefono').value, rol: document.getElementById('rol').value };
            }

            try {
                if (id) {
                    await setDoc(doc(db, type, id), data);
                } else {
                    await addDoc(collection(db, type), data);
                }
                closeModal();
            } catch (error) {
                console.error("Error guardando el documento: ", error);
            }
        }

        window.confirmDelete = (type, id) => {
            confirmModal.classList.remove('hidden');
            const confirmBtn = document.getElementById('confirm-delete-btn');
            const cancelBtn = document.getElementById('cancel-delete-btn');
            const newConfirmBtn = confirmBtn.cloneNode(true);
            confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            newConfirmBtn.addEventListener('click', () => handleDelete(type, id));
            cancelBtn.addEventListener('click', () => confirmModal.classList.add('hidden'));
        };
        async function handleDelete(type, id) {
            try {
                await deleteDoc(doc(db, type, id));
                confirmModal.classList.add('hidden');
                if (state.currentItemId === id) navigateTo(type);
            } catch (error) { console.error("Error eliminando el documento: ", error); }
        }

        // Funciones para el módulo de incidencias
        function renderIncidencias() {
            const incidencias = state.data.incidencias;
            const contratos = state.data.contratos;
            const incidenciasHtml = incidencias.map((inc) => {
                const contrato = contratos.find(c => c.id === inc.contrato_id);
                const propiedad = contrato ? state.data.propiedades.find(p => p.id === contrato.propiedad_id) : null;
                const direccion = propiedad?.direccion || "N/A";
                return `
                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                        <td class="py-3 px-6">${direccion}</td>
                        <td class="py-3 px-6">${inc.descripcion}</td>
                        <td class="py-3 px-6">${inc.estado}</td>
                        <td class="py-3 px-6 text-right">$${parseFloat(inc.costo || 0).toFixed(2)}</td>
                        <td class="py-3 px-6 text-center">
                            <div class="flex item-center justify-center">
                                <div onclick="window.openIncidenciaModal('${inc.id}')" class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110 cursor-pointer"><i class="fas fa-pencil-alt"></i></div>
                                <div onclick="window.deleteIncidencia('${inc.id}')" class="w-4 mr-2 transform hover:text-purple-500 hover:scale-110 cursor-pointer"><i class="fas fa-trash-alt"></i></div>
                            </div>
                        </td>
                    </tr>`;
            }).join('');
            mainContentArea.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800">Gestión de Incidencias</h1>
                    <button onclick="window.openIncidenciaModal()" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all">
                        <i class="fas fa-plus mr-2"></i>Nueva Incidencia
                    </button>
                </div>
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left">Propiedad</th>
                                <th class="py-3 px-6 text-left">Descripción</th>
                                <th class="py-3 px-6 text-left">Estado</th>
                                <th class="py-3 px-6 text-right">Costo</th>
                                <th class="py-3 px-6 text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="text-gray-600 text-sm font-light">
                            ${incidenciasHtml || '<tr><td colspan="5" class="text-center py-4">No hay incidencias registradas.</td></tr>'}
                        </tbody>
                    </table>
                </div>`;
        }

        async function openIncidenciaModal(id = null) {
            let data = { descripcion: '', estado: 'Nuevo', costo: '', contrato_id: '' };
            if (id) {
                const docSnap = await getDoc(doc(db, 'incidencias', id));
                if (docSnap.exists()) data = docSnap.data();
            }
            const contratos = state.data.contratos.map(c => {
                const prop = state.data.propiedades.find(p => p.id === c.propiedad_id);
                const inq = state.data.personas.find(p => p.id === c.inquilino_id);
                return `<option value="${c.id}" ${data.contrato_id === c.id ? 'selected' : ''}>${prop?.direccion || 'N/A'} - ${inq?.nombre || ''} ${inq?.apellido || ''}</option>`;
            }).join('');
            modalContent.innerHTML = `
                <h2 class="text-2xl font-bold mb-4">${id ? 'Editar' : 'Nueva'} Incidencia</h2>
                <form id="incidencia-form">
                    <input type="hidden" name="id" value="${id || ''}">
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Contrato</label>
                        <select name="contrato_id" class="shadow border rounded w-full py-2 px-3 text-gray-700" required>${contratos}</select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Descripción</label>
                        <textarea name="descripcion" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" rows="3" required>${data.descripcion}</textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Estado</label>
                        <select name="estado" class="shadow border rounded w-full py-2 px-3 text-gray-700" required>
                            <option ${data.estado === 'Nuevo' ? 'selected' : ''}>Nuevo</option>
                            <option ${data.estado === 'En proceso' ? 'selected' : ''}>En proceso</option>
                            <option ${data.estado === 'Solucionado' ? 'selected' : ''}>Solucionado</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Costo ($)</label>
                        <input name="costo" type="number" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" value="${data.costo || ''}">
                    </div>
                    <div class="mb-4">
                        <label class="block text-gray-700 text-sm font-bold mb-2">Archivo adjunto</label>
                        <input type="file" name="archivo" id="incidencia-archivo" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" />
                    </div>
                    <div class="flex items-center justify-end mt-6">
                        <button type="button" onclick="window.closeModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mr-2">Cancelar</button>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Guardar</button>
                    </div>
                </form>
            `;
            modal.classList.remove('hidden');
            document.getElementById('incidencia-form').addEventListener('submit', saveIncidencia);
        }

        // Reemplazamos saveIncidencia para permitir subir archivos a Firebase Storage
        async function saveIncidencia(e) {
            e.preventDefault();
            const form = e.target;
            const contratoId = form['contrato_id'].value;
            const descripcion = form['descripcion'].value;
            const estado = form['estado'].value;
            const costo = form['costo'].value;
            const archivoInput = form['archivo'];

            const incidenciaData = {
                contrato_id: contratoId,
                descripcion,
                estado,
                costo: costo ? parseFloat(costo) : 0,
                creado_en: Timestamp.now()
            };

            try {
                const incidenciaRef = await addDoc(collection(db, 'incidencias'), incidenciaData);

                if (archivoInput && archivoInput.files && archivoInput.files[0]) {
                    const file = archivoInput.files[0];
                    const storagePath = `incidencias/${incidenciaRef.id}/${file.name}`;
                    const fileRef = ref(storage, storagePath);
                    await uploadBytes(fileRef, file);
                    const archivoUrl = await getDownloadURL(fileRef);
                    await setDoc(incidenciaRef, { archivo_url: archivoUrl }, { merge: true });
                }

                alert('Incidencia guardada correctamente');
                form.reset();
                window.closeModal();
            } catch (error) {
                console.error('Error al guardar la incidencia:', error);
                alert('Hubo un error al guardar la incidencia.');
            }
        }

        async function deleteIncidencia(id) {
            if (confirm('¿Seguro que querés eliminar esta incidencia?')) {
                try {
                    await deleteDoc(doc(db, 'incidencias', id));
                } catch (e) {
                    console.error('Error eliminando incidencia', e);
                }
            }
        }

        // Exponemos las funciones para incidencias para que puedan ser utilizadas desde el HTML
        window.openIncidenciaModal = openIncidenciaModal;
        window.deleteIncidencia = deleteIncidencia;

        // ------------------------------------------------------------------
        // Funciones y vista para el módulo de liquidaciones
        // CONFIGURACIÓN: porcentaje de comisión (puede hacerse variable en el futuro)
        const COMISION_PORC = 5;

        /**
         * Rellena los selectores de propietario, mes y año para la sección de liquidaciones.
         * Lista los propietarios (personas con rol "Propietario") y carga los meses/años actuales.
         */
        async function poblarSelectoresLiquidacion() {
            const propietariosSel = document.getElementById('liquidacion-propietario');
            propietariosSel.innerHTML = "<option value=''>Seleccione propietario...</option>";
            // Obtener todas las personas con rol de propietario
            const personasSnap = await getDocs(query(collection(db, 'personas'), where("rol", "==", "Propietario")));
            personasSnap.forEach(docu => {
                const p = docu.data();
                propietariosSel.innerHTML += `<option value="${docu.id}">${p.nombre} ${p.apellido || ''}</option>`;
            });
            // Meses en español
            const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
            const mesSel = document.getElementById('liquidacion-mes');
            mesSel.innerHTML = meses.map((m,i) => `<option value="${i+1}">${m}</option>`).join('');
            mesSel.value = (new Date().getMonth()+1);
            // Años (actual y cinco anteriores)
            const anioSel = document.getElementById('liquidacion-anio');
            const anioActual = new Date().getFullYear();
            anioSel.innerHTML = '';
            for(let y = anioActual; y >= anioActual-5; y--) {
                anioSel.innerHTML += `<option value="${y}">${y}</option>`;
            }
        }

        /**
         * Calcula la liquidación mensual del propietario seleccionado para un mes y año dados.
         * Suma pagos de contratos activos, descuenta la comisión y los costos de incidencias.
         */
        async function calcularLiquidacion() {
            const propietarioId = document.getElementById('liquidacion-propietario').value;
            const mes = parseInt(document.getElementById('liquidacion-mes').value);
            const anio = parseInt(document.getElementById('liquidacion-anio').value);
            if(!propietarioId) {
                alert("Seleccione un propietario.");
                return;
            }
            // Obtener propiedades del propietario
            const propiedadesSnap = await getDocs(query(collection(db, 'propiedades'), where("propietario_id", "==", propietarioId)));
            const propiedades = [];
            propiedadesSnap.forEach(docu => propiedades.push({id: docu.id, ...docu.data()}));
            if(propiedades.length === 0) {
                mostrarResultado("Este propietario no tiene propiedades registradas.");
                return;
            }
            // Obtener contratos activos de esas propiedades
            const contratosSnap = await getDocs(query(collection(db, 'contratos'), where("propiedad_id", "in", propiedades.map(p=>p.id)), where("estado", "==", "activo")));
            const contratos = [];
            contratosSnap.forEach(docu => contratos.push({id: docu.id, ...docu.data()}));
            if(contratos.length === 0) {
                mostrarResultado("No hay contratos activos para este propietario.");
                return;
            }
            let ingresosTotales = 0;
            let pagosPorContrato = [];
            // Calcular pagos recibidos por cada contrato en el mes/año seleccionados
            for(const contrato of contratos) {
                const pagosSnap = await getDocs(query(collection(db, `contratos/${contrato.id}/pagos`), where("mes", "==", mes), where("anio", "==", anio), where("estado", "==", "Pagado")));
                let sumaPagos = 0;
                pagosSnap.forEach(pg => {
                    sumaPagos += pg.data().monto || contrato.monto_mensual;
                });
                if(sumaPagos > 0) {
                    ingresosTotales += sumaPagos;
                    pagosPorContrato.push({contrato, sumaPagos});
                }
            }
            // Calcular comisión
            const comision = Math.round(ingresosTotales * (COMISION_PORC/100));
            // Calcular costos de incidencias en el periodo
            let incidenciasTotales = 0;
            for(const contrato of contratos) {
                const incSnap = await getDocs(query(collection(db, 'incidencias'), where("contrato_id", "==", contrato.id)));
                incSnap.forEach(inc => {
                    const data = inc.data();
                    if(data.costo && data.creado_en && data.creado_en.toDate) {
                        const fecha = data.creado_en.toDate();
                        if(fecha.getMonth()+1 === mes && fecha.getFullYear() === anio) {
                            incidenciasTotales += data.costo;
                        }
                    }
                });
            }
            const totalTransferir = ingresosTotales - comision - incidenciasTotales;
            // Mostrar resultado
            mostrarResultado(`
                <h3 class="font-bold mb-2">Resumen de liquidación</h3>
                <ul class="mb-2">
                  ${propiedades.map(p=>`<li>🏠 ${p.direccion || p.nombre || p.id}</li>`).join('')}
                </ul>
                <div class="mb-2">Ingresos por alquileres: <b>$${ingresosTotales.toLocaleString()}</b></div>
                <div class="mb-2">Comisión (${COMISION_PORC}%): <b>-$${comision.toLocaleString()}</b></div>
                <div class="mb-2">Costos incidencias: <b>-$${incidenciasTotales.toLocaleString()}</b></div>
                <div class="font-bold text-lg">Total a transferir: $${totalTransferir.toLocaleString()}</div>
            `);
            document.getElementById('liquidacion-imprimir').classList.remove('hidden');
        }

        /**
         * Actualiza el contenedor de resultados de liquidación con el HTML proporcionado.
         */
        function mostrarResultado(html) {
            const resultContainer = document.getElementById('liquidacion-resultado');
            if(resultContainer) {
                resultContainer.innerHTML = html;
            }
        }

        /**
         * Renderiza la sección de liquidaciones, cargando el formulario y configurando los eventos necesarios.
         */
        function renderLiquidaciones() {
            mainContentArea.innerHTML = `
                <section id="liquidaciones-section" class="p-4">
                  <h2 class="text-xl font-bold mb-4">Liquidación mensual por propietario</h2>
                  <div class="mb-4 flex gap-2">
                    <select id="liquidacion-propietario" class="border rounded p-2"></select>
                    <select id="liquidacion-mes" class="border rounded p-2"></select>
                    <select id="liquidacion-anio" class="border rounded p-2"></select>
                    <button id="liquidacion-buscar" class="bg-blue-500 text-white px-4 rounded">Calcular</button>
                  </div>
                  <div id="liquidacion-resultado" class="bg-gray-50 p-4 rounded shadow"></div>
                  <button id="liquidacion-imprimir" class="mt-4 bg-green-600 text-white px-4 rounded hidden">Imprimir</button>
                </section>
            `;
            // Poblar selectores y asignar eventos de cálculo e impresión
            poblarSelectoresLiquidacion();
            document.getElementById('liquidacion-buscar').onclick = calcularLiquidacion;
            document.getElementById('liquidacion-imprimir').onclick = () => window.print();
        }

        /**
         * Abre el modal de detalle de contrato, muestra información básica y lista los pagos asociados.
         * Permite luego registrar nuevos pagos.
         * @param {string} contratoId Identificador del contrato
         */
        window.openDetalleContrato = async (contratoId) => {
            currentContratoId = contratoId;
            // Ocultamos el formulario de nuevo pago por defecto
            const nuevoPagoContainer = document.getElementById('nuevo-pago-form-container');
            if (nuevoPagoContainer) nuevoPagoContainer.classList.add('hidden');
            // Buscamos el contrato en el estado actual
            const contrato = state.data.contratos.find(c => c.id === contratoId) || null;
            if (!contrato) return;
            const prop = state.data.propiedades.find(p => p.id === contrato.propiedad_id) || {};
            const inquilino = state.data.personas.find(p => p.id === contrato.inquilino_id) || {};
            const infoHtml = `
                <p><strong>Propiedad:</strong> ${prop.direccion || 'N/A'}</p>
                <p><strong>Inquilino:</strong> ${(inquilino.nombre || '') + ' ' + (inquilino.apellido || '')}</p>
                <p><strong>Fecha inicio:</strong> ${contrato.fecha_inicio || ''}</p>
                <p><strong>Fecha fin:</strong> ${contrato.fecha_fin || ''}</p>
                <p><strong>Monto mensual:</strong> $${parseFloat(contrato.monto || contrato.monto_mensual || 0).toFixed(2)}</p>
            `;
            document.getElementById('detalle-contrato-info').innerHTML = infoHtml;
            // Mostrar información de aumentos si existe
            const aumentosDiv = document.getElementById('aumentos-info');
            const aplicarAumentoBtn = document.getElementById('aplicar-aumento-btn');
            if (aumentosDiv && aplicarAumentoBtn) {
                aumentosDiv.innerHTML = '';
                aplicarAumentoBtn.classList.add('hidden');
                if (contrato.aumento) {
                    const aum = contrato.aumento;
                    let html = `<p><strong>Tipo:</strong> ${aum.tipo || '-'}</p>`;
                    html += `<p><strong>Frecuencia:</strong> ${aum.frecuencia || '-'} meses</p>`;
                    html += `<p><strong>Fecha inicio:</strong> ${aum.fecha_inicio || '-'}</p>`;
                    // Historial de aumentos
                    if (contrato.historialAumentos && contrato.historialAumentos.length) {
                        html += '<p class="font-semibold mt-2">Historial de Aumentos:</p><ul class="list-disc ml-4">' + contrato.historialAumentos.map(h => `<li>${h.fecha}: $${parseFloat(h.monto).toFixed(2)}</li>`).join('') + '</ul>';
                    }
                    aumentosDiv.innerHTML = html;
                    aplicarAumentoBtn.classList.remove('hidden');
                }
            }
            // Cargamos pagos desde la subcolección "pagos"
            const pagosTbody = document.getElementById('pagos-list');
            pagosTbody.innerHTML = '';
            try {
                const pagosSnap = await getDocs(collection(db, `contratos/${contratoId}/pagos`));
                pagosSnap.forEach(pg => {
                    const p = pg.data();
                    const pagoId = pg.id;
                    pagosTbody.innerHTML += `<tr class="border-t"><td class="py-1 px-4">${p.mes}</td><td class="py-1 px-4">${p.anio}</td><td class="py-1 px-4">$${parseFloat(p.monto).toFixed(2)}</td><td class="py-1 px-4">${p.estado}</td><td class="py-1 px-4"><button class="text-blue-600 underline" onclick="window.generarRecibo('${contratoId}','${pagoId}')">PDF</button></td></tr>`;
                });
            } catch (error) {
                console.error('Error cargando pagos:', error);
            }
            // Mostrar modal
            document.getElementById('modal-detalle-contrato').classList.remove('hidden');
        };

        // Eventos para botones del modal de detalle de contrato. Se registran una sola vez al cargar la app.
        document.getElementById('cerrar-detalle-contrato-btn').addEventListener('click', () => {
            document.getElementById('modal-detalle-contrato').classList.add('hidden');
        });
        document.getElementById('agregar-pago-btn').addEventListener('click', () => {
            document.getElementById('nuevo-pago-form-container').classList.remove('hidden');
        });
        document.getElementById('cancelar-pago-btn').addEventListener('click', () => {
            document.getElementById('nuevo-pago-form').reset();
            document.getElementById('nuevo-pago-form-container').classList.add('hidden');
        });
        document.getElementById('nuevo-pago-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const mes = parseInt(document.getElementById('pago-mes').value);
            const anio = parseInt(document.getElementById('pago-anio').value);
            const monto = parseFloat(document.getElementById('pago-monto').value);
            const estado = document.getElementById('pago-estado').value;
            if (!mes || !anio || isNaN(monto) || !estado) {
                alert('Complete todos los campos del pago');
                return;
            }
            try {
                await addDoc(collection(db, `contratos/${currentContratoId}/pagos`), { mes, anio, monto, estado });
                // limpiamos formulario y ocultamos
                document.getElementById('nuevo-pago-form').reset();
                document.getElementById('nuevo-pago-form-container').classList.add('hidden');
                // recargar listado de pagos
                window.openDetalleContrato(currentContratoId);
            } catch (err) {
                console.error('Error al guardar el pago:', err);
                alert('Hubo un error al guardar el pago');
            }
        });

        // Botón para aplicar aumento de alquiler si está configurado en el contrato
        const aplicarAumentoBtn = document.getElementById('aplicar-aumento-btn');
        if (aplicarAumentoBtn) {
            aplicarAumentoBtn.addEventListener('click', async () => {
                try {
                    const contratoRef = doc(db, 'contratos', currentContratoId);
                    const contratoSnap = await getDoc(contratoRef);
                    if (!contratoSnap.exists()) {
                        alert('Contrato no encontrado');
                        return;
                    }
                    const c = contratoSnap.data();
                    if (!c.aumento) {
                        alert('Este contrato no tiene aumento configurado');
                        return;
                    }
                    // Calculamos un nuevo monto aplicando un incremento del 10% por defecto
                    const montoActual = c.monto || c.monto_mensual || 0;
                    let nuevoMonto = parseFloat(montoActual) * 1.10;
                    nuevoMonto = parseFloat(nuevoMonto.toFixed(2));
                    const historial = Array.isArray(c.historialAumentos) ? [...c.historialAumentos] : [];
                    const fechaHoy = new Date().toISOString().split('T')[0];
                    historial.push({ fecha: fechaHoy, monto: nuevoMonto });
                    await updateDoc(contratoRef, { monto: nuevoMonto, historialAumentos: historial });
                    alert('Aumento aplicado correctamente');
                    // Recargar detalles para reflejar cambios
                    window.openDetalleContrato(currentContratoId);
                } catch (err) {
                    console.error('Error al aplicar aumento:', err);
                    alert('Hubo un error al aplicar el aumento');
                }
            });
        }

        // Función para generar un recibo de pago en PDF. Utiliza jsPDF para componer el documento con la información del contrato,
        // la propiedad, el inquilino y el pago seleccionado. El archivo generado se descarga automáticamente en el navegador.
        window.generarRecibo = async (contratoId, pagoId) => {
            try {
                // Cargamos datos del contrato y del pago
                const contratoRef = doc(db, 'contratos', contratoId);
                const contratoSnap = await getDoc(contratoRef);
                if (!contratoSnap.exists()) {
                    alert('Contrato no encontrado');
                    return;
                }
                const contrato = contratoSnap.data();
                const pagoRef = doc(db, `contratos/${contratoId}/pagos`, pagoId);
                const pagoSnap = await getDoc(pagoRef);
                if (!pagoSnap.exists()) {
                    alert('Pago no encontrado');
                    return;
                }
                const pago = pagoSnap.data();
                // Buscamos información de propiedad e inquilino desde el estado en memoria
                const prop = state.data.propiedades.find(p => p.id === contrato.propiedad_id) || {};
                const inquilino = state.data.personas.find(p => p.id === contrato.inquilino_id) || {};
                // Configuramos jsPDF
                const { jsPDF } = window.jspdf;
                const docPdf = new jsPDF();
                let y = 10;
                docPdf.setFontSize(18);
                docPdf.text('Recibo de Alquiler', 105, y, { align: 'center' });
                y += 10;
                docPdf.setFontSize(12);
                docPdf.text(`Propiedad: ${prop.direccion || 'N/D'}`, 10, y);
                y += 7;
                docPdf.text(`Inquilino: ${(inquilino.nombre || '') + ' ' + (inquilino.apellido || '')}`, 10, y);
                y += 7;
                docPdf.text(`Contrato ID: ${contratoId}`, 10, y);
                y += 7;
                docPdf.text(`Periodo: ${pago.mes}/${pago.anio}`, 10, y);
                y += 7;
                docPdf.text(`Monto pagado: $${parseFloat(pago.monto).toFixed(2)}`, 10, y);
                y += 7;
                docPdf.text(`Estado del pago: ${pago.estado}`, 10, y);
                y += 7;
                docPdf.text(`Fecha de emisión: ${new Date().toLocaleDateString()}`, 10, y);
                // Guardamos el archivo con un nombre descriptivo
                const fileName = `Recibo_${contratoId}_${pago.mes}_${pago.anio}.pdf`;
                docPdf.save(fileName);
            } catch (err) {
                console.error('Error generando recibo:', err);
                alert('Ocurrió un error al generar el recibo');
            }
        };

        function setupRealtimeListeners() {
            // Incluimos la colección "incidencias" en los listeners en tiempo real
            ['propiedades', 'personas', 'contratos', 'incidencias'].forEach(colName => {
                onSnapshot(collection(db, colName), (snapshot) => {
                    state.data[colName] = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    renderCurrentSection();
                }, (error) => console.error(`Error en listener de ${colName}:`, error));
            });
        }
        
        function init() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(e.currentTarget.getAttribute('href').substring(1));
                });
            });
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    if (!state.isAuthReady) {
                        state.isAuthReady = true;
                        setupRealtimeListeners();
                    }
                } else {
                    signInAnonymously(auth).catch((error) => {
                        console.error("Error de autenticación anónima:", error);
                        mainContentArea.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert"><p class="font-bold">Error de Configuración</p><p>No se pudo conectar a la base de datos. Asegúrate de que el método de inicio de sesión <strong>"Anónimo"</strong> esté habilitado en tu consola de Firebase.</p></div>`;
                    });
                }
            });
        }
        init();
    </script>

    <!-- ==== SECCIÓN SPA: Módulo de Servicios ==== -->
    <section id="servicios-section" class="hidden p-4">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl font-bold">Servicios públicos</h2>
        <button class="bg-blue-600 text-white px-3 py-1 rounded" onclick="abrirModalServicio()">+ Nuevo servicio</button>
      </div>
      <!-- Filtros -->
      <div class="flex gap-2 mb-4">
        <select id="filtro-propiedad" class="border rounded p-1"></select>
        <select id="filtro-contrato" class="border rounded p-1"></select>
        <button onclick="renderServicios()" class="bg-gray-100 px-2 rounded">Filtrar</button>
        <button onclick="limpiarFiltrosServicios()" class="bg-gray-100 px-2 rounded">Limpiar</button>
      </div>
      <!-- Tabla de servicios -->
      <div class="overflow-x-auto">
        <table class="min-w-full text-xs border" id="tabla-servicios">
          <thead>
            <tr>
              <th class="border px-2 py-1">Propiedad</th>
              <th class="border px-2 py-1">Contrato</th>
              <th class="border px-2 py-1">Tipo</th>
              <th class="border px-2 py-1">Monto</th>
              <th class="border px-2 py-1">Vencimiento</th>
              <th class="border px-2 py-1">Estado</th>
              <th class="border px-2 py-1">Acciones</th>
            </tr>
          </thead>
          <tbody id="servicios-lista"></tbody>
        </table>
      </div>
      <!-- Modal NUEVO/EDITAR SERVICIO -->
      <dialog id="modal-servicio" class="rounded p-4 max-w-md w-[95vw]">
        <form id="form-servicio" class="flex flex-col gap-3">
          <input type="hidden" name="servicio_id" id="servicio-id" />
          <div>
            <label class="block text-xs">Propiedad</label>
            <select name="propiedad_id" id="servicio-propiedad" class="w-full border p-1 rounded" required></select>
          </div>
          <div>
            <label class="block text-xs">Contrato (opcional)</label>
            <select name="contrato_id" id="servicio-contrato" class="w-full border p-1 rounded"></select>
          </div>
          <div>
            <label class="block text-xs">Tipo de servicio</label>
            <select name="tipo" id="servicio-tipo" class="w-full border p-1 rounded" required>
              <option value="">Seleccionar...</option>
              <option value="Luz">Luz</option>
              <option value="Gas">Gas</option>
              <option value="Agua">Agua</option>
            </select>
          </div>
          <div>
            <label class="block text-xs">Monto</label>
            <input name="monto" id="servicio-monto" type="number" min="1" step="0.01" class="w-full border p-1 rounded" required />
          </div>
          <div>
            <label class="block text-xs">Fecha de vencimiento</label>
            <input name="vencimiento" id="servicio-vencimiento" type="date" class="w-full border p-1 rounded" required />
          </div>
          <div>
            <label class="block text-xs">Estado</label>
            <select name="estado" id="servicio-estado" class="w-full border p-1 rounded" required>
              <option value="Pendiente">Pendiente</option>
              <option value="Pagado">Pagado</option>
            </select>
          </div>
          <div class="flex justify-end gap-2 mt-2">
            <button type="button" onclick="cerrarModalServicio()" class="px-2 py-1 rounded border">Cancelar</button>
            <button type="submit" class="bg-blue-600 text-white px-2 py-1 rounded">Guardar</button>
          </div>
        </form>
      </dialog>
    </section>

    <!-- ==== SCRIPTS PARA MÓDULO DE SERVICIOS ==== -->
    <script type="module">
    // Firebase imports para el módulo de servicios
    import { getFirestore, collection, doc, getDoc, getDocs, setDoc, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    const db = getFirestore(app);

    // Cargar selects de propiedades y contratos
    async function cargarPropiedadesEnSelect(selectId, selected) {
      const snap = await getDocs(collection(db, "propiedades"));
      const sel = document.getElementById(selectId);
      sel.innerHTML = `<option value="">Seleccionar...</option>`;
      snap.forEach(docu => {
        const p = docu.data();
        sel.innerHTML += `<option value="${docu.id}"${docu.id===selected?' selected':''}>${p.direccion||p.nombre||docu.id}</option>`;
      });
    }
    async function cargarContratosEnSelect(selectId, selected, propiedadId = "") {
      let qy = collection(db, "contratos");
      if (propiedadId) qy = query(qy, where("propiedad_id", "==", propiedadId));
      const snap = await getDocs(qy);
      const sel = document.getElementById(selectId);
      sel.innerHTML = `<option value="">Ninguno</option>`;
      snap.forEach(docu => {
        const c = docu.data();
        sel.innerHTML += `<option value="${docu.id}"${docu.id===selected?' selected':''}>${c.nombre||docu.id}</option>`;
      });
    }
    document.getElementById("servicio-propiedad").onchange = e => {
      cargarContratosEnSelect("servicio-contrato", "", e.target.value);
    };

    // Filtros en tabla
    window.limpiarFiltrosServicios = () => {
      document.getElementById("filtro-propiedad").value = "";
      document.getElementById("filtro-contrato").value = "";
      renderServicios();
    };

    // Modal NUEVO/EDITAR
    window.abrirModalServicio = async function(servicio = null) {
      await cargarPropiedadesEnSelect("servicio-propiedad", servicio?.propiedad_id || "");
      await cargarContratosEnSelect("servicio-contrato", servicio?.contrato_id || "", servicio?.propiedad_id || "");
      document.getElementById("servicio-id").value = servicio?.id || "";
      document.getElementById("servicio-propiedad").value = servicio?.propiedad_id || "";
      document.getElementById("servicio-contrato").value = servicio?.contrato_id || "";
      document.getElementById("servicio-tipo").value = servicio?.tipo || "";
      document.getElementById("servicio-monto").value = servicio?.monto || "";
      document.getElementById("servicio-vencimiento").value = servicio?.vencimiento || "";
      document.getElementById("servicio-estado").value = servicio?.estado || "Pendiente";
      document.getElementById("modal-servicio").showModal();
    };
    window.cerrarModalServicio = () => document.getElementById("modal-servicio").close();

    // Guardar (create/update)
    document.getElementById("form-servicio").onsubmit = async function(e) {
      e.preventDefault();
      const propiedad_id = e.target["propiedad_id"].value;
      const contrato_id = e.target["contrato_id"].value || null;
      const tipo = e.target["tipo"].value;
      const monto = parseFloat(e.target["monto"].value);
      const vencimiento = e.target["vencimiento"].value;
      const estado = e.target["estado"].value;
      if (!propiedad_id || !tipo || !vencimiento || isNaN(monto) || monto <= 0) {
        alert("Completá todos los campos obligatorios y monto válido");
        return;
      }
      const servicio_id = document.getElementById("servicio-id").value;
      let servicioRef = servicio_id ? doc(db, "servicios", servicio_id) : doc(collection(db, "servicios"));
      const data = { propiedad_id, contrato_id, tipo, monto, vencimiento, estado };
      await setDoc(servicioRef, data, { merge: true });
      cerrarModalServicio();
      alert("Servicio guardado correctamente.");
      renderServicios();
    };

    // Listar y renderizar servicios
    async window.renderServicios = async function () {
      await cargarPropiedadesEnSelect("filtro-propiedad", "");
      await cargarContratosEnSelect("filtro-contrato", "");
      let qy = collection(db, "servicios");
      const filtroProp = document.getElementById("filtro-propiedad").value;
      const filtroCon = document.getElementById("filtro-contrato").value;
      if (filtroProp) qy = query(qy, where("propiedad_id", "==", filtroProp));
      if (filtroCon) qy = query(qy, where("contrato_id", "==", filtroCon));
      qy = query(qy, orderBy("vencimiento", "desc"));
      const snap = await getDocs(qy);
      let html = "";
      for (const docu of snap.docs) {
        const s = docu.data();
        html += `
          <tr>
            <td class="border px-2 py-1">${await nombrePropiedad(s.propiedad_id)}</td>
            <td class="border px-2 py-1">${await nombreContrato(s.contrato_id)}</td>
            <td class="border px-2 py-1">${s.tipo}</td>
            <td class="border px-2 py-1">$${s.monto}</td>
            <td class="border px-2 py-1">${s.vencimiento}</td>
            <td class="border px-2 py-1">
              <span class="${s.estado==='Pagado'?'text-green-600':'text-yellow-700'}">${s.estado}</span>
            </td>
            <td class="border px-2 py-1 flex gap-2">
              <button onclick="editarServicio('${docu.id}')" class="text-xs px-1 bg-blue-100 rounded">Editar</button>
              <button onclick="eliminarServicio('${docu.id}')" class="text-xs px-1 bg-red-100 rounded">Eliminar</button>
            </td>
          </tr>`;
      }
      document.getElementById("servicios-lista").innerHTML = html;
    }
    window.renderServicios = renderServicios;

    // Helpers para nombres de propiedad y contrato
    async function nombrePropiedad(id) {
      if (!id) return "-";
      const d = await getDoc(doc(db, "propiedades", id));
      return d.exists() ? (d.data().direccion || d.data().nombre || id) : id;
    }
    async function nombreContrato(id) {
      if (!id) return "-";
      const d = await getDoc(doc(db, "contratos", id));
      return d.exists() ? (d.data().nombre || id) : id;
    }

    // Editar y eliminar servicios
    window.editarServicio = async function(id) {
      const d = await getDoc(doc(db, "servicios", id));
      if (!d.exists()) return;
      abrirModalServicio({ ...d.data(), id });
    };
    window.eliminarServicio = async function(id) {
      if (!confirm("¿Eliminar servicio?")) return;
      await deleteDoc(doc(db, "servicios", id));
      renderServicios();
    };

    // Render automático al hacer clic en el menú de servicios
    document.querySelector("a[onclick*=\"navigateToSection('servicios-section')\"]")?.addEventListener("click", () => {
      renderServicios();
    });
        // === INICIO: FUNCIÓN DE NAVEGACIÓN SPA ===
window.navigateToSection = function(sectionId) {
  [
    'dashboard-section',
    'propiedades-section',
    'personas-section',
    'contratos-section',
    'incidencias-section',
    'liquidaciones-section',
    'servicios-section'
  ].forEach(id => {
    const sec = document.getElementById(id);
    if (sec) sec.classList.add('hidden');
  });

  const activeSec = document.getElementById(sectionId);
  if (activeSec) activeSec.classList.remove('hidden');

  document.querySelectorAll('aside button').forEach(btn => {
    btn.classList.remove('bg-gray-800', 'text-white');
  });

  const activeBtn = Array.from(document.querySelectorAll('aside button'))
    .find(btn => btn.getAttribute('onclick')?.includes(`'${sectionId}'`));
  if (activeBtn) {
    activeBtn.classList.add('bg-gray-800', 'text-white');
  }

  if (sectionId === 'servicios-section' && typeof renderServicios === 'function') {
    renderServicios();
  }
};
// === FIN DE LA FUNCIÓN DE NAVEGACIÓN SPA ===

    </script>
</body>
</html>
